<%- include('../partials/userHeader') %>


    <main class="main">
        <div class="page-header breadcrumb-wrap">
            <div class="container">
                <div class="breadcrumb">
                    <a href="index.html" rel="nofollow">Home</a>
                    <span></span> Pages
                    <span></span> Account
                </div>
            </div>
        </div>
        <section class="pt-150 pb-150">
            <div class="container">
                <div class="row">
                    <div class="col-lg-10 m-auto">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="dashboard-menu">
                                    <ul class="nav flex-column" role="tablist">
                                        <li class="nav-item">
                                            <a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab"
                                                href="#dashboard" role="tab" aria-controls="dashboard"
                                                aria-selected="false"><i
                                                    class="fi-rs-settings-sliders mr-10"></i>Dashboard</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="orders-tab" data-bs-toggle="tab" href="#orders"
                                                role="tab" aria-controls="orders" aria-selected="false"><i
                                                    class="fi-rs-shopping-bag mr-10"></i>Orders</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="track-orders-tab" data-bs-toggle="tab"
                                                href="#track-orders" role="tab" aria-controls="track-orders"
                                                aria-selected="false"><i
                                                    class="fi-rs-shopping-cart-check mr-10"></i>Track Your Order</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="address-tab" data-bs-toggle="tab" href="#address"
                                                role="tab" aria-controls="address" aria-selected="true"><i
                                                    class="fi-rs-marker mr-10"></i>My Address</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="account-detail-tab" data-bs-toggle="tab"
                                                href="#account-detail" role="tab" aria-controls="account-detail"
                                                aria-selected="true"><i class="fi-rs-user mr-10"></i>Account details</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" href="page-login-register.html"><i
                                                    class="fi-rs-sign-out mr-10"></i>Logout</a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div class="col-md-8">

                                <% if (!userDetails[0].setAccount) { %>
                                    <div class="d-flex justify-content-center">
                                        <div>
                                            <button type="button"
                                                class="cl0  pb-5 bg1 bor1 hov-btn1 p-lr-15 trans-04  btn-lg"
                                                data-bs-toggle="modal" data-bs-target="#enterProfileDetails">
                                                Set up your profile
                                            </button>
                                        </div>
                                    </div>
                                    <% } else {%>
                                        <div class="tab-content dashboard-content">
                                            <!-- dashboard content -->
                                            <div class="tab-pane fade active show" id="dashboard" role="tabpanel"
                                                aria-labelledby="dashboard-tab">
                                                <div class="card">
                                                    <img src="/<%= userDetails[0].profilePic %>"
                                                        alt="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png"
                                                        style="    width: 150px;
                                                        margin: 10px;
                                                        border-radius: 50px;" class=" mx-auto d-block" alt="...">

                                                    <div class=" card-header">
                                                        <h5 class="text-center fs-1">Hello <%= user.name %>! </h5>
                                                    </div>
                                                    <div class="card-body">
                                                        <p>From your account dashboard. you can easily check &amp; view
                                                            your <a href="#">recent orders</a>, manage your <a
                                                                href="#">shipping and
                                                                billing addresses</a> and <a href="#">edit your password
                                                                and
                                                                account details.</a></p>
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- ORDERS -->
                                            <div class="tab-pane fade" id="orders" role="tabpanel"
                                                aria-labelledby="orders-tab">
                                                <div class="card">
                                                    <div class="card-header">
                                                        <h5 class="mb-0">Your Orders</h5>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="table-responsive">
                                                            <table class="table">
                                                                <thead>
                                                                    <tr>
                                                                        <th>Order id</th>
                                                                        <th>Date</th>
                                                                        <th>Status</th>
                                                                        <th>Total</th>
                                                                        <th>Payment</th>
                                                                        <th>Cancel/Return</th>
                                                                        <th>Actions</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    <% orderDetails.forEach(order=> { %>
                                                                        <tr>
                                                                            <td>
                                                                                <%= order._id%>
                                                                            </td>
                                                                            <td>
                                                                                <%=
                                                                                    order.orderDate.toLocaleDateString('en-GB')%>
                                                                            </td>
                                                                            <td>
                                                                                <%= order.orderStatus %>
                                                                            </td>
                                                                            <td>
                                                                                Rs.<%=
                                                                                    order.totalAmount.toLocaleString()%>
                                                                            </td>
                                                                            <td>
                                                                                <%= order.paymentMethod %>
                                                                            </td>
                                                                            <td>
                                                                                <% console.log(order.orderStatus); %>
                                                                                    <% if (order.orderStatus=='placed'
                                                                                        ||order.orderStatus=='pending'
                                                                                        ||order.orderStatus=='Shipped' )
                                                                                        { %>
                                                                                        <button
                                                                                            class="btn btn-danger btn-sm "
                                                                                            onclick="cancelOrder('<%= order._id %>','cancelled')">
                                                                                            cancel
                                                                                        </button>
                                                                                        <% } else if
                                                                                            (order.orderStatus=='Delivered'
                                                                                            ){%>
                                                                                            <button
                                                                                                class="btn btn-warning btn-sm"
                                                                                                onclick="returnOrder('<%=order._id%>','return')">
                                                                                                return
                                                                                            </button>
                                                                                            <% } else
                                                                                                if(order.orderStatus=='cancelled'
                                                                                                ) {%>
                                                                                                <span
                                                                                                    class="badge bg-danger">Cancelled</span>
                                                                                                <% }else if
                                                                                                    (order.orderStatus=='return'
                                                                                                    ) {%>
                                                                                                    <span
                                                                                                        class="badge bg-warning">return</span>
                                                                                                    <% }%>

                                                                            </td>
                                                                            <td><a href="/viewOrderSummary/<%= order._id %>"
                                                                                    class="btn-small d-block">View</a>
                                                                            </td>
                                                                        </tr>
                                                                        <% }) %>
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- track your order -->
                                            <div class="tab-pane fade" id="track-orders" role="tabpanel"
                                                aria-labelledby="track-orders-tab">
                                                <div class="card">
                                                    <div class="card-header">
                                                        <h5 class="mb-0">Orders tracking</h5>
                                                    </div>
                                                    <div class="card-body contact-from-area">
                                                        <p>To track your order please enter your OrderID in the box
                                                            below and
                                                            press "Track" button. This was given to you on your receipt
                                                            and in
                                                            the confirmation email you should have received.</p>
                                                        <div class="row">
                                                            <div class="col-lg-8">
                                                                <form class="contact-form-style mt-30 mb-50" action="#"
                                                                    method="post">
                                                                    <div class="input-style mb-20">
                                                                        <label>Order ID</label>
                                                                        <input name="order-id"
                                                                            placeholder="Found in your order confirmation email"
                                                                            type="text" class="square">
                                                                    </div>
                                                                    <div class="input-style mb-20">
                                                                        <label>Billing email</label>
                                                                        <input name="billing-email"
                                                                            placeholder="Email you used during checkout"
                                                                            type="email" class="square">
                                                                    </div>
                                                                    <button class="submit submit-auto-width"
                                                                        type="submit">Track</button>
                                                                </form>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- add address -->
                                            <div class="tab-pane fade" id="address" role="tabpanel"
                                                aria-labelledby="address-tab">
                                                <div class="row">

                                                    <% userAddress.forEach(userAddress=> { %>
                                                        <div class="col-lg-6">
                                                            <div class="card mb-3 mb-lg-0">
                                                                <div class="card-header">
                                                                    <h5 class="mb-0">Your Address</h5>
                                                                </div>
                                                                <div class="card-body">
                                                                    <address>
                                                                        <%= userAddress.firstName %>
                                                                            <%= userAddress.lastName %>
                                                                                <br>
                                                                                <%= userAddress.address %>
                                                                                    <br>
                                                                                    <%= userAddress.city %>,<%=
                                                                                            userAddress.state %>
                                                                                            <br>
                                                                                            <%= userAddress.country %>
                                                                                                <br>
                                                                                                <%= userAddress.pincode
                                                                                                    %>
                                                                    </address>
                                                                    <div class="d-flex justify-content-end">
                                                                        <a href="/editAddress/<%= userAddress._id %>"
                                                                            type="button"
                                                                            class="cl0  pb-5 bg1 bor1 hov-btn1 p-lr-15 trans-04  btn-lg ">Edit</a>
                                                                        </p>
                                                                    </div>

                                                                </div>
                                                            </div>
                                                        </div>
                                                        <% }) %>

                                                            <div class="mt-5">
                                                                <a href="/addAddress">
                                                                    <button
                                                                        class="cl0  pb-5 bg1 bor1 hov-btn1 p-lr-15 trans-04  btn-lg ">
                                                                        Add Address <i
                                                                            class="fa-solid fa-circle-plus fa-lg"></i>
                                                                    </button>
                                                                </a>
                                                            </div>
                                                </div>
                                            </div>
                                            <!-- account details -->
                                            <div class="tab-pane fade" id="account-detail" role="tabpanel"
                                                aria-labelledby="account-detail-tab">
                                                <div class="card">
                                                    <div class="card-header">
                                                        <h5>Account Details</h5>
                                                    </div>
                                                    <div class="card-body">
                                                        <form method="post" name="enq">
                                                            <div class="row">
                                                                <!-- profile pic -->
                                                                <div>
                                                                    <img src="/<%= userDetails[0].profilePic %>"
                                                                        alt="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png"
                                                                        style="width: 150px;
                                                                margin: 10px;
                                                                border-radius: 50px;" class=" mx-auto d-block"
                                                                        alt="...">
                                                                    <div class="d-flex justify-content-center">

                                                                        <button type="button" class=""
                                                                            data-bs-toggle="modal"
                                                                            data-bs-target="#changeProPic" style="position: absolute;
                                                                        top: 27%;">
                                                                            <i class="fa-solid fa-pen-to-square"></i>
                                                                        </button>

                                                                    </div>
                                                                </div>

                                                                <div class="form-group col-md-12">
                                                                    <label>Display Name </label>
                                                                    <input required="" class="form-control square"
                                                                        name="dname" type="text"
                                                                        value="<%= userDetails[0].userDetails[0].name %>"
                                                                        style="background: #d2d2d4; border-radius: 20px;">

                                                                </div>
                                                                <div>
                                                                    <label>Date of Birth</label>
                                                                    <input type="text" name="DOB" id=""
                                                                        value="<%= userDetails[0].DOB %>"
                                                                        style="background: #d2d2d4; border-radius: 20px;">
                                                                </div>
                                                                <div class="form-group col-md-12">
                                                                    <label>Email Address </label>
                                                                    <input required="" class="form-control square"
                                                                        name="email" type="email"
                                                                        value="<%= userDetails[0].userDetails[0].email %>"
                                                                        style="background: #d2d2d4; border-radius: 20px;">
                                                                </div>

                                                                <div class="form-group col-md-12">
                                                                    <label>Mobile </label>
                                                                    <input required="" class="form-control"
                                                                        name="mobile" type="text"
                                                                        value="<%= userDetails[0].userDetails[0].phone %>"
                                                                        style="background: #d2d2d4; border-radius: 20px;">
                                                                </div>

                                                                <div class="col-md-12 mt-5 d-flex justify-content-end"
                                                                    style="margin-top: 20px;">
                                                                    <button type="button"
                                                                        class="cl0  pb-5 bg1 bor1 hov-btn1 p-lr-15 trans-04  btn-lg"
                                                                        data-bs-toggle="modal"
                                                                        data-bs-target="#editDetails">
                                                                        Edit
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>


                                        <% } %>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Button trigger modal -->


            <!-- Modal for new profile set up if not -->
            <div class="modal fade" id="enterProfileDetails" tabindex="-1" aria-labelledby="exampleModalLabel"
                aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="card-body">
                                <form method="post" action="/postSetUpProfile" id="myForm" name="enq"
                                    enctype="multipart/form-data">
                                    <div class="row">
                                        <!-- profile pic -->
                                        <div>
                                            <img src="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png"
                                                style="    width: 100px;margin: 10px;border-radius: 50px;"
                                                class=" mx-auto d-block" alt="...">
                                            <div class="d-flex justify-content-center">
                                                <input type="file" name="image" accept=".jpg, .png, .jpeg"
                                                    id="profilePic">
                                            </div>
                                        </div>

                                        <div class="form-group col-md-12">
                                            <label>Display Name </label>
                                            <input required="" class="form-control square" name="name" type="text"
                                                value="" style="background: #d2d2d4; border-radius: 20px;">

                                        </div>
                                        <div>
                                            <label>Date of Birth</label>
                                            <input type="text" name="DOB" id=""
                                                style="background: #d2d2d4; border-radius: 20px;">
                                        </div>
                                        <div class="form-group col-md-12">
                                            <label>Email Address </label>
                                            <input required="" class="form-control square" name="email" type="email"
                                                value="" style="background: #d2d2d4; border-radius: 20px;">
                                        </div>

                                        <div class="form-group col-md-12">
                                            <label>Mobile </label>
                                            <input required="" class="form-control" name="mobile" type="text" value=""
                                                style="background: #d2d2d4; border-radius: 20px;">
                                        </div>


                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary"
                                            data-bs-dismiss="modal">Close</button>
                                        <button type="submit" class="btn btn-primary">Save changes</button>
                                    </div>
                                </form>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Modal for editing profile-->
            <div class="modal fade" id="editDetails" tabindex="-1" aria-labelledby="exampleModalLabel"
                aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="card-body">
                                <form method="post" action="/postEditProfile" id="editProfile" name="enq"
                                    enctype="multipart/form-data">
                                    <div class="row">
                                        <!-- profile pic -->
                                        <div>
                                            <img src="/<%= userDetails[0].profilePic %>"
                                                style="    width: 100px;margin: 10px;border-radius: 50px;"
                                                class=" mx-auto d-block" alt="...">
                                            <div class="d-flex justify-content-center">
                                                <input type="file" name="image" accept=".jpg, .png, .jpeg"
                                                    id="profilePic" value="<%= userDetails[0].profilePic %>">
                                            </div>
                                        </div>

                                        <div class="form-group col-md-12">
                                            <label>Display Name </label>
                                            <input required="" class="form-control square" name="name" type="text"
                                                value="<%= userDetails[0].userDetails[0].name %>"
                                                style="background: #d2d2d4; border-radius: 20px;">

                                        </div>
                                        <div>
                                            <label>Date of Birth</label>
                                            <input type="text" name="DOB" id="" value="<%= userDetails[0].DOB %>"
                                                style="background: #d2d2d4; border-radius: 20px;">
                                        </div>
                                        <div class="form-group col-md-12">
                                            <label>Email Address </label>
                                            <input required="" class="form-control square" name="email" type="email"
                                                value="<%= userDetails[0].userDetails[0].email %>"
                                                style="background: #d2d2d4; border-radius: 20px;">
                                        </div>

                                        <div class="form-group col-md-12">
                                            <label>Mobile </label>
                                            <input required="" class="form-control" name="mobile" type="text"
                                                value="<%= userDetails[0].userDetails[0].phone %>"
                                                style="background: #d2d2d4; border-radius: 20px;">
                                        </div>


                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary"
                                            data-bs-dismiss="modal">Close</button>
                                        <button type="submit" class="btn btn-primary">Save changes</button>
                                    </div>
                                </form>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- modal for changing profile pic -->
            <div class="modal fade" id="changeProPic" tabindex="-1" aria-labelledby="exampleModalLabel"
                aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">change profile picture</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="card-body">
                                <form method="post" action="/postChangeImage" id="changePic" name="enq"
                                    enctype="multipart/form-data">
                                    <div class="row">
                                        <!-- profile pic -->
                                        <div>
                                            <img src="/<%= userDetails[0].profilePic %>"
                                                style="    width: 100px;margin: 10px;border-radius: 50px;"
                                                class=" mx-auto d-block" id="imageView" alt="...">
                                            <div class="d-flex justify-content-center">
                                                <input type="file" name="image" accept=".jpg, .png, .jpeg"
                                                    id="profilePic" value="<%= userDetails[0].profilePic %>"
                                                    onchange="viewImage(event)">
                                            </div>
                                            <div>
                                                <button type="button" class="btn btn-primary btn-small"  data-bs-toggle="modal"
                                                    data-bs-target="#exampleModal">
                                                    crop
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary"
                                            data-bs-dismiss="modal">Close</button>
                                        <button type="submit" class="btn btn-primary">Save changes</button>
                                    </div>
                                </form>
                            </div>
                        </div>

                    </div>
                </div>
            </div>


            <!--image crop modal-->
            <!-- Button trigger modal -->
            <!-- Modal -->
            <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel"
                aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content" style="width: 130%;">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5" id="exampleModalLabel">crop image</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                           
                                <img src="/<%= userDetails[0].profilePic %>" id="croppingImage" alt="Cropping Image">

                        </div>
                        <div>
                            <button class="btn btn-primary" id="cropButton">
                                crop
                                </button></div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary">Save changes</button>
                        </div>
                    </div>
                </div>
            </div>



        </section>
    </main>

    <script>

        function viewImage(event) {
            document.getElementById('imageView').src = URL.createObjectURL(event.target.files[0])
        }
    </script>
    <script>

        function cancelOrder(orderId, status) {
            Swal.fire({
                title: "Are you sure?",
                text: "you are going to cancel the order",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "Yes",
                cancelButtonText: "No"
            }).then((confirmed) => {
                if (confirmed.value) {
                    $.ajax({
                        url: '/cancelOrder',
                        method: 'post',
                        data: {
                            orderId: orderId,
                            status: status
                        }
                    }).done(res => {
                        Swal.fire({
                            title: "Success",
                            text: res.message,
                            icon: "success"
                        }).then(() => {
                            location.reload();
                        });
                    });
                } else {
                    Swal.fire({
                        title: "Cancelled",
                        text: "Your action has been cancelled",
                        icon: "info"
                    });
                }
            });
        }


        function returnOrder(orderId, status) {
            Swal.fire({
                title: "Are you sure?",
                text: "you are going to reurn the order",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "Yes",
                cancelButtonText: "No"
            }).then((confirmed) => {
                if (confirmed.value) {
                    $.ajax({
                        url: '/returnOrder',
                        method: 'post',
                        data: {
                            orderId: orderId,
                            status: status
                        }
                    }).done(res => {
                        Swal.fire({
                            title: "Success",
                            text: res.message,
                            icon: "success"
                        }).then(() => {
                            location.reload();
                        });
                    });
                } else {
                    Swal.fire({
                        title: "Cancelled",
                        text: "Your action has been cancelled",
                        icon: "info"
                    });
                }
            });
        }

    </script>

    <%- include('../partials/userFooter') %>